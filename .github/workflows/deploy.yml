# .github/workflows/deploy.yml

name: Next.js cPanel Auto-Deployment (SSH Git Pull - Fixed)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4

      - name: Remote Deployment via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 22

          script: |
            cd ${{ secrets.DEPLOY_DIR }}
            echo "üìÅ Current directory: $(pwd)"

            # --- START: GIT CHECK AND PULL/CLONE ---
            if [ ! -d ".git" ]; then
              echo 'üîÑ Repository not found. Performing initial GIT CLONE using HTTPS...'
              git clone ${{ secrets.REPO_URL }} temp_repo
              mv temp_repo/.git .
              mv temp_repo/* .
              rm -rf temp_repo
              echo '‚úÖ Initial clone completed successfully.'
            else
              echo 'üîÅ Repository found. Performing GIT PULL...'
              /usr/bin/git pull origin main
            fi
            # --- END: GIT CHECK AND PULL/CLONE ---

            # --- NODE.JS ENVIRONMENT ---
            echo '‚öôÔ∏è Activating Node.js environment...'
            source ${{ secrets.NODE_ENV_PATH }}

            echo 'üßπ Cleaning old node_modules (fix symlink issues)...'
            rm -rf node_modules
            mkdir -p node_modules

            echo 'üì¶ Installing Node.js dependencies...'
            npm install --no-audit --force --include=dev

            echo 'üèóÔ∏è Building Next.js application (no Turbopack)...'
            NEXT_USE_TURBOPACK=0 npm run build

            echo 'üîÅ Restarting application process...'
            touch tmp/restart.txt

            echo "‚úÖ Deployment process finished successfully!"
