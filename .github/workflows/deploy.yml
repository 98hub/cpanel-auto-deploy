# .github/workflows/deploy.yml

name: Next.js cPanel Auto-Deployment (SSH Git Pull)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4

      - name: Remote Deployment via SSH
        uses: appleboy/ssh-action@master
        with:
          # Kredensial Koneksi
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }} 
          port: 22

          script: |
            cd ${{ secrets.DEPLOY_DIR }}

            echo "Current directory: $(pwd)"

            # --- START: GIT CHECK AND PULL/CLONE ---

            if [ ! -d ".git" ]; then
              echo 'Repository not found. Performing initial GIT CLONE using HTTPS...'
              git clone ${{ secrets.REPO_URL }} temp_repo
              
              mv temp_repo/.git .
              mv temp_repo/* .
              rm -rf temp_repo
              
              echo 'Initial clone completed successfully.'
            else
              echo 'Repository found. Performing GIT PULL...'
              /usr/bin/git pull origin main
            fi

            # --- END: GIT CHECK AND PULL/CLONE ---

            # --- NEXT.JS REMOTE DEPLOYMENT STEPS ---

            echo 'Activating Node.js environment...'
            source ${{ secrets.NODE_ENV_PATH }}

            echo 'Installing Node.js dependencies...'
            npm install --no-audit --force --include=dev

            echo 'Building Next.js application...'
            npm run build --no-turbo

            echo 'Restarting application process...'
            touch tmp/restart.txt 

            echo "Deployment process finished successfully!"
