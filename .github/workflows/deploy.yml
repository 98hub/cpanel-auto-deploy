name: Next.js Deployment ke cPanel via SSH

on:
  push:
    branches:
      - main # Ganti jika branch utama Anda berbeda

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Kode Sumber
        uses: actions/checkout@v4

      - name: 2. Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: 3. Instal Dependencies dan Lakukan Build (Di Runner GitHub)
        run: |
          npm ci
          npm run build
          # Pengecekan: Pastikan folder utama standalone dan static ada
          echo "Verifikasi konten build Next.js (sebelum transfer):"
          ls -ld .next/standalone || true # Hanya cek direktori induk
          ls -R .next/static || true

      - name: 4a. Transfer File Server (Standalone & Config)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 22
          rm: false
          debug: true
          # Hanya transfer server file dan folder standalone di sini
          source: |
            .next/standalone
            package.json
            app.js
          target: ${{ secrets.DEPLOY_DIR }}

      - name: 4b. Transfer File Statis (Static & Public)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 22
          # rm: false di sini karena kita ingin membersihkan file di Langkah 5
          rm: false
          debug: true
          # Hanya transfer aset statis di sini
          source: |
            .next/static
            public
          target: ${{ secrets.DEPLOY_DIR }}

      - name: 5. Eksekusi Perintah di cPanel (via SSH)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 22
          debug: true
          script: |
            # 1. Setup Environment dan Pindah ke Direktori Aplikasi
            source ${{ secrets.NODE_ENV_PATH }}
            cd ${{ secrets.DEPLOY_DIR }}

            # 2. EKSTRAKSI DAN PEMINDAHAN KONTEN (Langkah Kritis)
            # Karena SCP menyalin folder .next/standalone, kita harus memindahkan isinya ke root.
            echo "Memindahkan konten standalone ke root aplikasi..."

            # Pindahkan KONTEN dari .next/standalone (server files, node_modules internal) ke DEPLOY_DIR
            mv .next/standalone/* .

            # Hapus folder sementara .next/standalone
            rm -rf .next/standalone

            # 3. Instal Dependencies Produksi ke Path Khusus cPanel
            echo "Memastikan node_modules diarahkan ke path yang benar: ${{ secrets.NPM_PREFIX_DIR }}/lib/node_modules"
            npm config set prefix ${{ secrets.NPM_PREFIX_DIR }}
            npm install --production 

            # 4. Restart Aplikasi
            echo "Restart Aplikasi (Trigger cPanel App Manager)..."
            touch app.js

            echo "Deployment Selesai!"
